package cn.zjiali.robot.test.json

import cn.zjiali.robot.model.response.ServerResponse
import cn.zjiali.robot.model.server.PluginInfo
import cn.zjiali.robot.util.JsonUtil
import cn.zjiali.robot.util.ObjectUtil
import kotlinx.serialization.decodeFromString
import kotlinx.serialization.json.Json
import net.mamoe.mirai.utils.BotConfiguration
import org.junit.Test
import xyz.cssxsh.mirai.tool.FixProtocolVersion

/**
 *
 *
 * @author zJiaLi
 * @since 2022-11-25 18:37
 */
class InnerJsonTest {

    private val json1 = Json { ignoreUnknownKeys = true }

    @Test
    fun testPluginConfigJson() {

        val json: String =
            """{"msg":"操作成功","code":200,"data":[{"searchValue":null,"createBy":"admin","createTime":"2022-06-18 00:49:35","updateBy":"admin","updateTime":"2022-06-18 00:49:35","delFlag":"0","params":{},"id":1,"pluginName":"一言","pluginCode":"oneSen","pluginDesc":"获取优美句子","pluginStatus":1,"pluginClass":"cn.zjiali.robot.handler.SenMessageEventHandler","pluginAuthor":"zJiaLi","pluginContact":"QQ:357078415","pluginConfigList":[{"searchValue":null,"createBy":"admin","createTime":"2022-06-28 10:03:59","updateBy":"admin","updateTime":"2022-06-28 10:03:59","delFlag":"0","params":{},"id":12,"configName":"触发命令","configKey":"command","configValue":"一言","inMap":"0","pluginId":1,"pluginCode":"oneSen"},{"searchValue":null,"createBy":"admin","createTime":"2022-06-28 10:04:22","updateBy":"admin","updateTime":"2022-06-28 10:04:22","delFlag":"0","params":{},"id":13,"configName":"请求地址","configKey":"url","configValue":"https://robot.zjiali.cn/api/getSen","inMap":"1","pluginId":1,"pluginCode":"oneSen"},{"searchValue":null,"createBy":"admin","createTime":"2022-11-25 09:49:09","updateBy":"admin","updateTime":"2022-11-25 09:49:09","delFlag":"0","params":{},"id":39,"configName":"模板标识","configKey":"templateFlag","configValue":"0","inMap":"0","pluginId":1,"pluginCode":"oneSen"}]},{"searchValue":null,"createBy":"admin","createTime":"2022-06-26 10:53:17","updateBy":"admin","updateTime":"2022-06-26 10:53:17","delFlag":"0","params":{},"id":2,"pluginName":"签到","pluginCode":"sign","pluginDesc":"每日签到","pluginStatus":1,"pluginClass":"cn.zjiali.robot.handler.SignInMessageEventHandler","pluginAuthor":"zJiaLi","pluginContact":"QQ:357078415","pluginConfigList":[{"searchValue":null,"createBy":"admin","createTime":"2022-06-26 13:03:03","updateBy":"admin","updateTime":"2022-06-26 13:03:03","delFlag":"0","params":{},"id":7,"configName":"触发命令","configKey":"command","configValue":"签到,积分查询","inMap":"0","pluginId":2,"pluginCode":"sign"},{"searchValue":null,"createBy":"admin","createTime":"2022-06-26 13:03:30","updateBy":"admin","updateTime":"2022-06-26 13:03:30","delFlag":"0","params":{},"id":8,"configName":"签到模板","configKey":"signTemplate","configValue":"签到成功!\n💸获得积分: {getPoints}点\n⭐本月积累签到: {monthDay}天\n💳当前积分: {points}点\n⭐当前等级: {currentLevel}\n⭐每日一句: {todayMsg}","inMap":"1","pluginId":2,"pluginCode":"sign"},{"searchValue":null,"createBy":"admin","createTime":"2022-06-26 13:03:56","updateBy":"admin","updateTime":"2022-06-26 13:03:56","delFlag":"0","params":{},"id":9,"configName":"签到接口地址","configKey":"signUrl","configValue":"https://robot.zjiali.cn/api/signIn","inMap":"1","pluginId":2,"pluginCode":"sign"},{"searchValue":null,"createBy":"admin","createTime":"2022-06-26 13:04:25","updateBy":"admin","updateTime":"2022-06-26 13:04:25","delFlag":"0","params":{},"id":10,"configName":"积分查询模板","configKey":"querySignTemplate","configValue":"💸总积分: {points}点\n⭐连续签到: {monthDay}天\n💳总签到天数: {totalDay}天\n⭐当前等级: {currentLevel}\n⭐每日一句: {todayMsg}","inMap":"1","pluginId":2,"pluginCode":"sign"},{"searchValue":null,"createBy":"admin","createTime":"2022-06-26 13:04:44","updateBy":"admin","updateTime":"2022-06-26 13:04:44","delFlag":"0","params":{},"id":11,"configName":"积分查询接口地址","configKey":"querySignUrl","configValue":"https://robot.zjiali.cn/api/querySignInData","inMap":"1","pluginId":2,"pluginCode":"sign"},{"searchValue":null,"createBy":"admin","createTime":"2022-11-25 09:49:38","updateBy":"admin","updateTime":"2022-11-25 09:49:38","delFlag":"0","params":{},"id":40,"configName":"模板标识","configKey":"templateFlag","configValue":"2","inMap":"0","pluginId":2,"pluginCode":"sign"}]},{"searchValue":null,"createBy":"admin","createTime":"2022-06-26 10:54:03","updateBy":"admin","updateTime":"2022-06-26 10:54:03","delFlag":"0","params":{},"id":3,"pluginName":"今日运势","pluginCode":"fortune","pluginDesc":"获取每日运势","pluginStatus":1,"pluginClass":"cn.zjiali.robot.handler.FortuneMessageEventHandler","pluginAuthor":"zJiaLi","pluginContact":"QQ:357078415","pluginConfigList":[{"searchValue":null,"createBy":"admin","createTime":"2022-06-28 10:04:50","updateBy":"admin","updateTime":"2022-06-28 10:04:50","delFlag":"0","params":{},"id":14,"configName":"触发命令","configKey":"command","configValue":"运势","inMap":"0","pluginId":3,"pluginCode":"fortune"},{"searchValue":null,"createBy":"admin","createTime":"2022-06-28 10:05:18","updateBy":"admin","updateTime":"2022-06-28 10:05:18","delFlag":"0","params":{},"id":15,"configName":"运势模板","configKey":"template","configValue":"🌓您的今日运势为: {fortuneSummary}\n🌟星指数: {luckyStar}\n📗签文: {signText}\n📝解签: {unSignText}","inMap":"0","pluginId":3,"pluginCode":"fortune"},{"searchValue":null,"createBy":"admin","createTime":"2022-06-28 10:05:56","updateBy":"admin","updateTime":"2022-06-28 10:05:56","delFlag":"0","params":{},"id":16,"configName":"每日一次","configKey":"day_one","configValue":"0","inMap":"1","pluginId":3,"pluginCode":"fortune"},{"searchValue":null,"createBy":"admin","createTime":"2022-06-28 10:06:15","updateBy":"admin","updateTime":"2022-06-28 10:06:15","delFlag":"0","params":{},"id":17,"configName":"使用积分","configKey":"point","configValue":"0","inMap":"1","pluginId":3,"pluginCode":"fortune"},{"searchValue":null,"createBy":"admin","createTime":"2022-06-28 10:06:31","updateBy":"admin","updateTime":"2022-06-28 10:06:31","delFlag":"0","params":{},"id":18,"configName":"请求地址","configKey":"url","configValue":"https://robot.zjiali.cn/api/getFortuneOfToday","inMap":"1","pluginId":3,"pluginCode":"fortune"},{"searchValue":null,"createBy":"admin","createTime":"2022-11-25 09:50:01","updateBy":"admin","updateTime":"2022-11-25 09:50:01","delFlag":"0","params":{},"id":41,"configName":"模板标识","configKey":"templateFlag","configValue":"1","inMap":"0","pluginId":3,"pluginCode":"fortune"}]},{"searchValue":null,"createBy":"admin","createTime":"2022-06-26 10:55:43","updateBy":"admin","updateTime":"2022-06-26 10:55:43","delFlag":"0","params":{},"id":4,"pluginName":"老黄历","pluginCode":"yellowCalendar","pluginDesc":"今日老黄历","pluginStatus":1,"pluginClass":"cn.zjiali.robot.handler.YellowCalendarMessageEventHandler","pluginAuthor":"zJiaLi","pluginContact":"QQ:35708415","pluginConfigList":[{"searchValue":null,"createBy":"admin","createTime":"2022-06-28 10:17:50","updateBy":"admin","updateTime":"2022-06-28 10:17:50","delFlag":"0","params":{},"id":19,"configName":"触发命令","configKey":"command","configValue":"老黄历","inMap":"0","pluginId":4,"pluginCode":"yellowCalendar"},{"searchValue":null,"createBy":"admin","createTime":"2022-06-28 10:18:21","updateBy":"admin","updateTime":"2022-06-28 10:18:21","delFlag":"0","params":{},"id":20,"configName":"消息模板","configKey":"template","configValue":"今日老黄历:\n阳历:{yangli}\n阴历:{yinli}\n五行:{wuxing}\n冲煞:{chongsha}\n彭祖百忌:{baiji}\n吉神宜趋:{jishen}\n宜:{yi}\n凶神宜忌:{xiongshen}\n忌:{ji}","inMap":"0","pluginId":4,"pluginCode":"yellowCalendar"},{"searchValue":null,"createBy":"admin","createTime":"2022-06-28 10:18:50","updateBy":"admin","updateTime":"2022-06-28 10:18:50","delFlag":"0","params":{},"id":21,"configName":"请求地址","configKey":"url","configValue":"https://robot.zjiali.cn/api/yellowCalendar","inMap":"1","pluginId":4,"pluginCode":"yellowCalendar"},{"searchValue":null,"createBy":"admin","createTime":"2022-11-25 09:51:11","updateBy":"admin","updateTime":"2022-11-25 09:51:11","delFlag":"0","params":{},"id":42,"configName":"模板标识","configKey":"templateFlag","configValue":"1","inMap":"0","pluginId":4,"pluginCode":"yellowCalendar"}]},{"searchValue":null,"createBy":"admin","createTime":"2022-06-26 10:56:10","updateBy":"admin","updateTime":"2022-06-26 10:56:10","delFlag":"0","params":{},"id":5,"pluginName":"万年历","pluginCode":"calendar","pluginDesc":"今日万年历","pluginStatus":1,"pluginClass":"cn.zjiali.robot.handler.CalendarMessageEventHandler","pluginAuthor":"zJiaLi","pluginContact":"QQ:357078415","pluginConfigList":[{"searchValue":null,"createBy":"admin","createTime":"2022-06-28 10:19:26","updateBy":"admin","updateTime":"2022-06-28 10:19:26","delFlag":"0","params":{},"id":22,"configName":"触发命令","configKey":"command","configValue":"万年历","inMap":"0","pluginId":5,"pluginCode":"calendar"},{"searchValue":null,"createBy":"admin","createTime":"2022-06-28 10:20:20","updateBy":"admin","updateTime":"2022-06-28 10:20:20","delFlag":"0","params":{},"id":23,"configName":"消息模板","configKey":"template","configValue":"今日万年历:\n假日:{holiday}\n忌:{avoid}\n属相:{animalsYear}\n假日描述:{desc}\n周几:{weekday}\n宜:{suit}\n纪年:{lunarYear}\n农历:{lunar}\n具体日期:{date}","inMap":"0","pluginId":5,"pluginCode":"calendar"},{"searchValue":null,"createBy":"admin","createTime":"2022-06-28 10:20:45","updateBy":"admin","updateTime":"2022-06-28 10:20:45","delFlag":"0","params":{},"id":24,"configName":"请求地址","configKey":"url","configValue":"https://robot.zjiali.cn/api/perpetualCalendar","inMap":"1","pluginId":5,"pluginCode":"todayHistory"},{"searchValue":null,"createBy":"admin","createTime":"2022-11-25 09:51:59","updateBy":"admin","updateTime":"2022-11-25 09:51:59","delFlag":"0","params":{},"id":43,"configName":"模板标识","configKey":"templateFlag","configValue":"1","inMap":"0","pluginId":5,"pluginCode":"calendar"}]},{"searchValue":null,"createBy":"admin","createTime":"2022-06-26 10:56:41","updateBy":"admin","updateTime":"2022-06-26 10:56:41","delFlag":"0","params":{},"id":6,"pluginName":"历史上的今天","pluginCode":"todayHistory","pluginDesc":"历史上的今天","pluginStatus":1,"pluginClass":"cn.zjiali.robot.handler.TodayOfHistoryMessageEventHandler","pluginAuthor":"zJiaLi","pluginContact":"QQ:357078415","pluginConfigList":[{"searchValue":null,"createBy":"admin","createTime":"2022-06-28 10:22:42","updateBy":"admin","updateTime":"2022-06-28 10:22:42","delFlag":"0","params":{},"id":25,"configName":"请求地址","configKey":"url","configValue":"https://robot.zjiali.cn/api/todayOfHistory","inMap":"1","pluginId":6,"pluginCode":"todayHistory"},{"searchValue":null,"createBy":"admin","createTime":"2022-10-20 10:48:05","updateBy":"admin","updateTime":"2022-10-20 10:48:05","delFlag":"0","params":{},"id":38,"configName":"触发命令","configKey":"command","configValue":"历史上的今天","inMap":"0","pluginId":6,"pluginCode":"todayHistory"},{"searchValue":null,"createBy":"admin","createTime":"2022-11-25 09:53:12","updateBy":"admin","updateTime":"2022-11-25 09:53:12","delFlag":"0","params":{},"id":45,"configName":"模板标识","configKey":"templateFlag","configValue":"0","inMap":"0","pluginId":6,"pluginCode":"todayHistory"}]},{"searchValue":null,"createBy":"admin","createTime":"2022-06-26 10:57:15","updateBy":"admin","updateTime":"2022-06-26 10:57:15","delFlag":"0","params":{},"id":7,"pluginName":"笑话","pluginCode":"joke","pluginDesc":"获取笑话","pluginStatus":1,"pluginClass":"cn.zjiali.robot.handler.JokeMessageEventHandler","pluginAuthor":"zJiaLi","pluginContact":"QQ:357078415","pluginConfigList":[{"searchValue":null,"createBy":"admin","createTime":"2022-06-28 10:23:59","updateBy":"admin","updateTime":"2022-06-28 10:23:59","delFlag":"0","params":{},"id":26,"configName":"触发命令","configKey":"command","configValue":"笑话","inMap":"0","pluginId":7,"pluginCode":"joke"},{"searchValue":null,"createBy":"admin","createTime":"2022-06-28 10:24:39","updateBy":"admin","updateTime":"2022-06-28 10:24:39","delFlag":"0","params":{},"id":27,"configName":"请求地址","configKey":"url","configValue":"https://robot.zjiali.cn/api/queryJoke","inMap":"1","pluginId":7,"pluginCode":"joke"},{"searchValue":null,"createBy":"admin","createTime":"2022-11-25 09:53:30","updateBy":"admin","updateTime":"2022-11-25 09:53:30","delFlag":"0","params":{},"id":46,"configName":"模板标识","configKey":"templateFlag","configValue":"0","inMap":"0","pluginId":7,"pluginCode":"joke"}]},{"searchValue":null,"createBy":"admin","createTime":"2022-06-26 10:58:01","updateBy":"admin","updateTime":"2022-06-26 10:58:01","delFlag":"0","params":{},"id":8,"pluginName":"灵签","pluginCode":"lq","pluginDesc":"观音灵签、月老灵签、财神灵签","pluginStatus":1,"pluginClass":"cn.zjiali.robot.handler.SpiritSignMessageEventHandler","pluginAuthor":"zJiaLi","pluginContact":"QQ:357078415","pluginConfigList":[{"searchValue":null,"createBy":"admin","createTime":"2022-06-28 10:26:04","updateBy":"admin","updateTime":"2022-06-28 10:26:04","delFlag":"0","params":{},"id":28,"configName":"触发命令","configKey":"command","configValue":"观音灵签,月老灵签,财神灵签","inMap":"0","pluginId":8,"pluginCode":"lq"},{"searchValue":null,"createBy":"admin","createTime":"2022-06-28 10:26:44","updateBy":"admin","updateTime":"2022-06-28 10:26:44","delFlag":"0","params":{},"id":29,"configName":"请求地址","configKey":"url","configValue":"https://robot.zjiali.cn/lq/oneSignPerDay","inMap":"1","pluginId":8,"pluginCode":"lq"},{"searchValue":null,"createBy":"admin","createTime":"2022-06-28 11:08:59","updateBy":"admin","updateTime":"2022-06-28 11:08:59","delFlag":"0","params":{},"id":30,"configName":"观音灵签模板","configKey":"gyTemplate","configValue":"{title}\n诗曰:{shi_yue}\n诗意:{shi_yi}\n解曰:{jie_yue}\n本签精髓:{bqjs}\n详情请点击:{viewUrl}","inMap":"1","pluginId":8,"pluginCode":"lq"},{"searchValue":null,"createBy":"admin","createTime":"2022-06-28 11:12:31","updateBy":"admin","updateTime":"2022-06-28 11:12:31","delFlag":"0","params":{},"id":31,"configName":"月老灵签模板","configKey":"ylTemplate","configValue":"{title}\n签诗:{qian_shi}\n解签:{jie_qian}\n详情请点击:{viewUrl}","inMap":"1","pluginId":8,"pluginCode":"lq"},{"searchValue":null,"createBy":"admin","createTime":"2022-06-28 11:12:55","updateBy":"admin","updateTime":"2022-06-28 11:12:55","delFlag":"0","params":{},"id":32,"configName":"财神灵签模板","configKey":"csTemplate","configValue":"{title}\n诗曰:{shi_yue}\n吉凶:{ji_xiong}\n详情请点击:{viewUrl}","inMap":"1","pluginId":8,"pluginCode":"lq"},{"searchValue":null,"createBy":"admin","createTime":"2022-11-25 09:53:50","updateBy":"admin","updateTime":"2022-11-25 09:53:50","delFlag":"0","params":{},"id":47,"configName":"灵签","configKey":"templateFlag","configValue":"2","inMap":"0","pluginId":8,"pluginCode":"lq"}]},{"searchValue":null,"createBy":"admin","createTime":"2022-06-26 10:58:52","updateBy":"admin","updateTime":"2022-06-26 10:58:52","delFlag":"0","params":{},"id":9,"pluginName":"点歌","pluginCode":"request_song","pluginDesc":"点歌","pluginStatus":1,"pluginClass":"cn.zjiali.robot.handler.RequestSongMessageEventHandler","pluginAuthor":"zJiaLi","pluginContact":"QQ:357078415","pluginConfigList":[{"searchValue":null,"createBy":"admin","createTime":"2022-06-28 11:15:04","updateBy":"admin","updateTime":"2022-06-28 11:15:04","delFlag":"0","params":{},"id":33,"configName":"触发命令","configKey":"command","configValue":"点歌","inMap":"0","pluginId":9,"pluginCode":"request_song"},{"searchValue":null,"createBy":"admin","createTime":"2022-06-28 11:15:30","updateBy":"admin","updateTime":"2022-06-28 11:15:30","delFlag":"0","params":{},"id":34,"configName":"请求地址","configKey":"url","configValue":"https://robot.zjiali.cn/api/song/requestSong","inMap":"1","pluginId":9,"pluginCode":"request_song"},{"searchValue":null,"createBy":"admin","createTime":"2022-11-25 09:54:05","updateBy":"admin","updateTime":"2022-11-25 09:54:05","delFlag":"0","params":{},"id":48,"configName":"点歌","configKey":"templateFlag","configValue":"0","inMap":"0","pluginId":9,"pluginCode":"request_song"}]},{"searchValue":null,"createBy":"admin","createTime":"2022-06-26 10:59:37","updateBy":"admin","updateTime":"2022-06-26 10:59:37","delFlag":"0","params":{},"id":10,"pluginName":"茉莉聊天","pluginCode":"MOLI","pluginDesc":"智能聊天","pluginStatus":1,"pluginClass":"cn.zjiali.robot.handler.MoLiMessageEventHandler","pluginAuthor":"zJiaLi","pluginContact":"QQ:357078415","pluginConfigList":[{"searchValue":null,"createBy":"admin","createTime":"2022-06-28 11:16:21","updateBy":"admin","updateTime":"2022-06-28 11:16:21","delFlag":"0","params":{},"id":35,"configName":"过滤关键字","configKey":"ignoreKeyWords","configValue":"天气,ip,@qq,@lol,@sfz,@sjh,@cy,笑话,观音灵签,月老灵签,财神爷灵签","inMap":"0","pluginId":10,"pluginCode":"MOLI"},{"searchValue":null,"createBy":"admin","createTime":"2022-06-28 11:16:56","updateBy":"admin","updateTime":"2022-06-28 11:16:56","delFlag":"0","params":{},"id":36,"configName":"是否需要@触发","configKey":"chatGroupAt","configValue":"1","inMap":"1","pluginId":10,"pluginCode":"MOLI"},{"searchValue":null,"createBy":"admin","createTime":"2022-06-28 11:17:30","updateBy":"admin","updateTime":"2022-06-28 11:17:30","delFlag":"0","params":{},"id":37,"configName":"请求地址","configKey":"zUrlChat","configValue":"https://robot.zjiali.cn/api/getChatReply","inMap":"1","pluginId":10,"pluginCode":"MOLI"},{"searchValue":null,"createBy":"admin","createTime":"2022-11-25 09:54:28","updateBy":"admin","updateTime":"2022-11-25 09:54:28","delFlag":"0","params":{},"id":49,"configName":"模板标识","configKey":"templateFlag","configValue":"0","inMap":"0","pluginId":10,"pluginCode":"MOLI"}]}]}"""
        val response =
            json1.decodeFromString<ServerResponse<MutableList<PluginInfo>>>(json)
        println(response)

    }

    @Test
    fun testMapJson() {
        val param = HashMap<String, Any>()
        param["robot"] = "357078415"
        val encodeToString = JsonUtil.obj2str(param)
        println(encodeToString)
        println(switchProtocol("4"))
        println(switchProtocol("3"))
        println(switchProtocol("1"))
        println(switchProtocol(""))
        println(switchProtocol("2"))
    }

    private fun switchProtocol(robotProtocol: String): BotConfiguration.MiraiProtocol {
        val protocol: BotConfiguration.MiraiProtocol = if (!ObjectUtil.isNullOrEmpty(robotProtocol)) {
            when (robotProtocol) {
                "1" -> {
                    BotConfiguration.MiraiProtocol.ANDROID_PAD
                }

                "2" -> {
                    BotConfiguration.MiraiProtocol.ANDROID_WATCH
                }

                "3" -> {
                    BotConfiguration.MiraiProtocol.IPAD
                }

                "4" -> {
                    BotConfiguration.MiraiProtocol.MACOS
                }

                else -> {
                    BotConfiguration.MiraiProtocol.ANDROID_PHONE
                }
            }
        } else {
            BotConfiguration.MiraiProtocol.ANDROID_PHONE
        }
        FixProtocolVersion.sync(protocol)
//        FixProtocolVersion.load(protocol)
        println("${protocol}是否支持QR登录${protocol.isQRLoginSupported}")
        return protocol
    }
}